<!DOCTYPE html>
<html lang="en-us">
<head>
    
        
<meta charset="utf-8">
<meta name="HandheldFriendly" content="True">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="referrer" content="no-referrer-when-downgrade">

<title>A little code generation in Go in 2020. - Sudarshan&#39;s Blog</title>
<meta name="description" content="">

<link rel="icon" type="image/x-icon" href="https://geekandlatin.com/favicon.ico">
<link rel="apple-touch-icon-precomposed" href="https://geekandlatin.com/favicon.png">

<link rel="stylesheet" href="https://geekandlatin.com/css/style.css?rnd=1591527353" />



<meta property="og:title" content="A little code generation in Go in 2020." />
<meta property="og:description" content="Perl gives me headaches. But I&rsquo;m fond of one of Larry Wall&rsquo;s three virtues: Laziness. This is a story of how sometimes laziness lets you do fun things.
Distributed systems and microservices are as ubiquitous as the coronavirus in 2020. This results in a requirement for a lot of integration. And a nice way to maintain the glue code is to use SDKs rather than have multiple services write the transport glue themselves." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://geekandlatin.com/post/code-gen/" />
<meta property="article:published_time" content="2020-03-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-03-14T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="A little code generation in Go in 2020."/>
<meta name="twitter:description" content="Perl gives me headaches. But I&rsquo;m fond of one of Larry Wall&rsquo;s three virtues: Laziness. This is a story of how sometimes laziness lets you do fun things.
Distributed systems and microservices are as ubiquitous as the coronavirus in 2020. This results in a requirement for a lot of integration. And a nice way to maintain the glue code is to use SDKs rather than have multiple services write the transport glue themselves."/>







    
</head>
<body>
    <a class="skip-main" href="#main">Skip to main content</a>
    <div class="container">
        <header> 
            
                <h1 class="site-header">
    <a href="/">Sudarshan&#39;s Blog</a>
</h1>
<nav>
    
    
    <a class="" href="https://geekandlatin.com/about/" title="">About</a>
    
    <a class="" href="https://geekandlatin.com/tags/" title="">Tags</a>
    
    <a class="" href="https://github.com/sudarshan-reddy/" title="">Github</a>
    
</nav>

            
        </header>
        <main id="main" tabindex="-1"> 
            

    <article class="post">
        <header>
            <h1 class="post-title">A little code generation in Go in 2020.</h1>
        </header>
        <div class="content">
            <p>Perl gives me headaches. But I&rsquo;m fond of one of Larry Wall&rsquo;s <a href="http://threevirtues.com/">three virtues</a>:
<code>Laziness</code>. This is a story of how sometimes laziness lets you do fun things.</p>
<p>Distributed systems and microservices are as ubiquitous as the coronavirus in 2020. This
results in a requirement for a lot of integration. And a nice way to maintain the glue
code is to use SDKs rather than have multiple services write the transport glue themselves.
Like so&hellip;</p>
<p><img src="https://sudarshan-reddy.github.io/images/microservices.jpg" alt="microservices"></p>
<p>It was all nice and fun until we had to start writing an SDK for each new microservice.</p>
<p>And each new endpoint.</p>
<p>And each new parameter addition.</p>
<p>Generating these parts would make new additions trivial, keep the SDK codebases
homogenous and eliminate the occurence of manual errors.</p>
<p>So the SDK has two components. The component that is manually built and the parts
that can be generated. Here is a layout of the project.</p>
<pre><code>---
 - client
 - api.go
 - methods.go
 - go.mod
 - go.sum
</code></pre><p>client is the http.Client embedded with some retry logic etc. It has two methods
that are important. NewRequest which creates a wrapped http request and Send()
which is sort of like <code>client.Do()</code>.</p>
<p>api.go is a collection of all the methods attached to an interface that the sdk exposes.</p>
<p>methods.go is what we want to generate. It will be a collection of implementations
of helpers that call the api and parse and respond readable Go structures. Like so:</p>
<p><code>https://awesomewebsite/v1/getdetails</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">client</span>) <span style="color:#a6e22e">GetDetails</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">Details</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">op</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Operation</span>{
		<span style="color:#a6e22e">HTTPMethod</span>: <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>,
		<span style="color:#a6e22e">HTTPPath</span>:   <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/v1/getdetails&#34;</span>,
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Details</span>
	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">cl</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">op</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Send</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>If you notice, most of the code is tedious housekeeping that gets repeated. So getrandomstuff
becomes</p>
<p><code>https://awesomewebsite/v1/getrandomstuff</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">client</span>) <span style="color:#a6e22e">GetRandomStuff</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">RandomStuff</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">op</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Operation</span>{
		<span style="color:#a6e22e">HTTPMethod</span>: <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">MethodGet</span>,
		<span style="color:#a6e22e">HTTPPath</span>:   <span style="color:#a6e22e">endpoint</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/v1/getrandomstuff&#34;</span>,
	}

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">response</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">RandomStuff</span>
	<span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">cl</span>.<span style="color:#a6e22e">NewRequest</span>(<span style="color:#a6e22e">op</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">Send</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">response</span>, <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>Step in code generation. Now what I wanted to do was to use a specification that
the user is able to add a configuration that the generator captures and
translates into something like the snippets about. Lets define a set of rules to outline this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Generator</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">Generate</span>(<span style="color:#a6e22e">Reader</span>, <span style="color:#a6e22e">Writer</span>) <span style="color:#66d9ef">error</span>
}

<span style="color:#75715e">// Reader is a general wrapper on io.Reader to read an input to obtain
</span><span style="color:#75715e">// the apis.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reader</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">ReadAPI</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Reader</span>) ([]<span style="color:#a6e22e">API</span>, <span style="color:#66d9ef">error</span>)
}

<span style="color:#75715e">// Writer is a general wrapper on io.Writer to write the processed file.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Writer</span> <span style="color:#66d9ef">interface</span> {
	<span style="color:#a6e22e">WriteAPI</span>(<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>, []<span style="color:#a6e22e">API</span>) <span style="color:#66d9ef">error</span>
}
</code></pre></div><p>So, we need something to Read from and somewhere to Write.</p>
<h2 id="reader">Reader</h2>
<p>Multiple options presented themselves.</p>
<p><strong>It could be an API specification:</strong> But everyone hates swagger so much. It seemed to be punishment for
the developers to write the yaml with all of swagger&rsquo;s quirks.</p>
<p>Writing Swagger yamls are painful and so there is no example.</p>
<p><strong>It could be a JSON/XML based configuration system:</strong> Still needed the developer to work on a different
&ldquo;language/syntax&rdquo; compared to what the rest of the codebase was.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;methods&#34;</span>: [
        {
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;GetDetails&#34;</span>,
            <span style="color:#f92672">&#34;endpoint&#34;</span>: <span style="color:#e6db74">&#34;v1/getdetails&#34;</span>,
            <span style="color:#f92672">&#34;verb&#34;</span>: <span style="color:#e6db74">&#34;Get&#34;</span>,
            <span style="color:#f92672">&#34;inputParams&#34;</span>: [],
            <span style="color:#f92672">&#34;outputParams&#34;</span>: [
                {<span style="color:#f92672">&#34;Details&#34;</span>: {}}
            ]
        },
        {
            <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;GetRandomStuff&#34;</span>,
            <span style="color:#f92672">&#34;endpoint&#34;</span>: <span style="color:#e6db74">&#34;v1/getrandomstuff&#34;</span>,
            <span style="color:#f92672">&#34;verb&#34;</span>: <span style="color:#e6db74">&#34;Get&#34;</span>,
            <span style="color:#f92672">&#34;inputParams&#34;</span>: [],
            <span style="color:#f92672">&#34;outputParams&#34;</span>: [
                {<span style="color:#f92672">&#34;RandomStuff&#34;</span>: {}}
            ]
        }
    ]
}
</code></pre></div><p><strong>It could be an interface also written in Go:</strong> The user will have to add a method to an interface
and define the structures. The downside of this is the http endpoint and verb have to be annoted.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Client</span> <span style="color:#66d9ef">interface</span>{
    <span style="color:#75715e">// Get v1/getdetails
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">GetDetails</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">Details</span>, <span style="color:#66d9ef">error</span>) 

    <span style="color:#75715e">// Get v1/getrandomstuff
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">GetRandomStuff</span>() (<span style="color:#f92672">*</span><span style="color:#a6e22e">RandomStuff</span>, <span style="color:#66d9ef">error</span>) 
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Details</span> <span style="color:#66d9ef">struct</span>{}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RandomStuff</span> <span style="color:#66d9ef">struct</span>{}
</code></pre></div><p>Out of these three options, the one I preferred was adding to the interface.
It seemed intuitive and granted control to a Go developer. It also presented the biggest challenge
of the three. Reading an AST. We could obviously just read the file like a plaintext
but that seems very hacky and tightly coupled to a pre-conceived notion of how we expect
the signatures to be written. Granted, we still expect annotations to be in a certain way
but its much more malleable.</p>
<h3 id="ast---quick-primer">AST - Quick primer</h3>
<p>ASTs are very common in compiled languages. An AST is an intermediate form of representation
of code that the compiler can read and optimize. If you think about it,
what we are doing is what a compiler would do. The only difference here being us translating
go code to more go code. This brings us to&hellip;</p>
<h3 id="compilers---very-very-quick-primer">Compilers - Very very quick primer</h3>
<p>Most compilers break down into three primary stages: Parsing, Transformation and
Code Generation.</p>
<p><strong>Parsing:</strong> Parsing is generally broken down into Lexical analysis and synctactic analysis.
A lexer generally is responsible for this <code>tokenization</code> process. Tokens are tiny little
objects that describe an isolated piece of the syntax. They could be numbers, operators
or symbols amongst other things.
Syntactic analysis is what we are interested in. It takes the tokens and builds an
intermediate representation called the Abstract Syntax Tree.
Luckily for us, go allows us to use their tools: go/ast, go/parser, go/token.</p>
<p>I&rsquo;m not the biggest fan of the <code>internal</code> package in go but code generators
seem to be the perfect candidate to put in here.</p>
<p>I created two packages <code>internal/generator/</code> and <code>internal/cmd</code> to add the generator
code.</p>
<p>The parsing part of the AST was already done by Go. All I had to do was to
call the already existing functions like so&hellip;</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#a6e22e">fs</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">NewFileSet</span>()
	<span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ParseFile</span>(<span style="color:#a6e22e">fs</span>, <span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">parser</span>.<span style="color:#a6e22e">ParseComments</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
    }
</code></pre></div><p><strong>Transformation:</strong> Transformation is manipulating the AST to make changes to it
to enable the final process of&hellip;</p>
<p>I wanted to transform the AST into a data model that would be easy for the code
generation to happen. I laid out a structure like this because I was dealing with
APIs and their methods.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// API is a set of indicatives that we will loop through
</span><span style="color:#75715e">// to generate code.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">API</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">InterfaceName</span> <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Methods</span>       []<span style="color:#a6e22e">Method</span>
}

<span style="color:#75715e">// Method represents a set of metadata levels details that belong
</span><span style="color:#75715e">// to an api method.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Method</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Endpoint</span>     <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">MethodName</span>   <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Path</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Verb</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">Body</span>         <span style="color:#66d9ef">string</span>
	<span style="color:#a6e22e">InputParams</span>  []<span style="color:#a6e22e">Parameter</span>
	<span style="color:#a6e22e">OutputParams</span> []<span style="color:#a6e22e">Parameter</span>
}
</code></pre></div><p>Now that I had the AST parsed thanks to <code>ParseFile</code>, I had to loop through
it to obtain:</p>
<ul>
<li>All the interface declarations.</li>
<li>All the methods attached to the interface declarations.</li>
<li>The input and output parameters of these methods.</li>
<li>The code annotation talking about the http verb and endpoint.</li>
</ul>
<p><code>Decls</code> is all the declarations. We loop through that and assert for
interfaces.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">...</span>
	<span style="color:#75715e">// loop through all the top level declarations of the AST.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">decl</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Decls</span> {
		<span style="color:#75715e">// We don&#39;t care about functional declarations, so lets pick
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// only the generic ones.
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">decl</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">decl</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">GenDecl</span>)
		<span style="color:#75715e">// We don&#39;t really need to process token.TYPE.
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">decl</span>.<span style="color:#a6e22e">Tok</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">TYPE</span> {
			<span style="color:#66d9ef">continue</span>
		}

		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">api</span> <span style="color:#a6e22e">API</span>
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">spec</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">decl</span>.<span style="color:#a6e22e">Specs</span> {
			<span style="color:#75715e">//We only want to read through type declarations.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">typeSpec</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">spec</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">TypeSpec</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">continue</span>
			}

			<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">InterfaceName</span> = <span style="color:#a6e22e">typeSpec</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">String</span>()

			<span style="color:#75715e">// Again, we are only interested in Interface definitions.
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">interfaceType</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">typeSpec</span>.<span style="color:#a6e22e">Type</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">InterfaceType</span>)
			<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
				<span style="color:#66d9ef">continue</span>
			}
<span style="color:#f92672">...</span>

</code></pre></div><p>Now that we have the interfaces we extract the other stuff we mentioned above
from 2-4.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getMethods</span>(<span style="color:#a6e22e">fields</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Field</span>) []<span style="color:#a6e22e">Method</span> {
    	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">methods</span> = make([]<span style="color:#a6e22e">Method</span>, <span style="color:#ae81ff">0</span>)
    	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fields</span> {
    		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Names</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
    			<span style="color:#66d9ef">continue</span>
    		}
    
    		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ignore</span> <span style="color:#66d9ef">bool</span>
    		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">matches</span> [][]<span style="color:#66d9ef">string</span>
    		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">d</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Doc</span>.<span style="color:#a6e22e">List</span> {
    			<span style="color:#a6e22e">comment</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">extractComment</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Text</span>)
    			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">comment</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;Ignore&#34;</span> {
    				<span style="color:#a6e22e">ignore</span> = <span style="color:#66d9ef">true</span>
    			} <span style="color:#66d9ef">else</span> {
    				<span style="color:#a6e22e">matches</span> = <span style="color:#a6e22e">verbEndpointRegex</span>.<span style="color:#a6e22e">FindAllStringSubmatch</span>(<span style="color:#a6e22e">comment</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
    			}
    		}
    		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ignore</span> {
    			<span style="color:#66d9ef">continue</span>
    		}
    
    		<span style="color:#a6e22e">fn</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Type</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">FuncType</span>)
    		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
    			<span style="color:#66d9ef">continue</span>
    		}
    
    		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">methodData</span> <span style="color:#a6e22e">Method</span>
    		<span style="color:#a6e22e">methodData</span>.<span style="color:#a6e22e">Verb</span> = <span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]
    		<span style="color:#a6e22e">methodData</span>.<span style="color:#a6e22e">Path</span> = <span style="color:#a6e22e">matches</span>[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]
    		<span style="color:#a6e22e">methodData</span>.<span style="color:#a6e22e">MethodName</span> = <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Names</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">String</span>()
    		<span style="color:#a6e22e">methodData</span>.<span style="color:#a6e22e">InputParams</span> = <span style="color:#a6e22e">getFields</span>(<span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">Params</span>.<span style="color:#a6e22e">List</span>)
    		<span style="color:#a6e22e">methodData</span>.<span style="color:#a6e22e">OutputParams</span> = <span style="color:#a6e22e">getFields</span>(<span style="color:#a6e22e">fn</span>.<span style="color:#a6e22e">Results</span>.<span style="color:#a6e22e">List</span>)
    
    		<span style="color:#a6e22e">methods</span> = append(<span style="color:#a6e22e">methods</span>, <span style="color:#a6e22e">methodData</span>)
    	}
    	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">methods</span>
    }
    
    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">extractComment</span>(<span style="color:#a6e22e">comment</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">string</span> {
    	<span style="color:#a6e22e">slashRemoved</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Trim</span>(<span style="color:#a6e22e">comment</span>, <span style="color:#e6db74">&#34;//&#34;</span>)
    	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Trim</span>(<span style="color:#a6e22e">slashRemoved</span>, <span style="color:#e6db74">&#34; &#34;</span>)
    }
    
    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getFields</span>(<span style="color:#a6e22e">fields</span> []<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Field</span>) []<span style="color:#a6e22e">Parameter</span> {
    	<span style="color:#a6e22e">params</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">Parameter</span>, <span style="color:#ae81ff">0</span>)
    	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">field</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fields</span> {
    		<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
    		<span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Names</span>) &gt; <span style="color:#ae81ff">0</span> {
    			<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Names</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Name</span>
    		}
    		<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">field</span>.<span style="color:#a6e22e">Type</span>.(<span style="color:#66d9ef">type</span>) {
    		<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">SelectorExpr</span>:
    			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Parameter</span>{
    				<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
    				<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">selectorToString</span>(<span style="color:#a6e22e">t</span>),
    			}
    			<span style="color:#a6e22e">params</span> = append(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">p</span>)
    		<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">StarExpr</span>:
    			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Parameter</span>{
    				<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
    				<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">starToString</span>(<span style="color:#a6e22e">t</span>),
    			}
    			<span style="color:#a6e22e">params</span> = append(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">p</span>)
    		<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Ident</span>:
    			<span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Parameter</span>{
    				<span style="color:#a6e22e">Name</span>: <span style="color:#a6e22e">name</span>,
    				<span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Name</span>,
    			}
    			<span style="color:#a6e22e">params</span> = append(<span style="color:#a6e22e">params</span>, <span style="color:#a6e22e">p</span>)
    		}
    
    	}
    	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">params</span>
    }
    
    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">selectorToString</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">SelectorExpr</span>) <span style="color:#66d9ef">string</span> {
    	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">param</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
    	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ident</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">X</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Ident</span>); <span style="color:#a6e22e">ok</span> {
    		<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">ident</span>.<span style="color:#a6e22e">Name</span>)
    	}
    	<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#e6db74">&#34;.&#34;</span>)
    	<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Sel</span>.<span style="color:#a6e22e">Name</span>)
    	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">String</span>()
    }
    
    <span style="color:#66d9ef">func</span> <span style="color:#a6e22e">starToString</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">StarExpr</span>) <span style="color:#66d9ef">string</span> {
    	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">param</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
    	<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#e6db74">&#34;*&#34;</span>)
    	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ident</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">X</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">ast</span>.<span style="color:#a6e22e">Ident</span>); <span style="color:#a6e22e">ok</span> {
    		<span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">WriteString</span>(<span style="color:#a6e22e">ident</span>.<span style="color:#a6e22e">Name</span>)
    	}
    	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">param</span>.<span style="color:#a6e22e">String</span>()
    }
</code></pre></div><p><strong>Code Generation:</strong> Is basically generating runnable, optimized code in the format
the compiler wants and for that we have the &hellip;</p>
<h2 id="writer">Writer</h2>
<p>The writer reads the transformation we applied (The API struct) and uses go&rsquo;s
interesting template library to inject the values.</p>
<p>The template library to achieve our example looks like so</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fnTmpl</span> = <span style="color:#e6db74">`
</span><span style="color:#e6db74">		</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">$i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">separator</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#75715e">}}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">		</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">$o</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">separator</span> <span style="color:#e6db74">&#34;, &#34;</span><span style="color:#75715e">}}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">		</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">$length</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">len</span> <span style="color:#a6e22e">.OutputParams</span><span style="color:#75715e">}}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">		func (c *client) </span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.MethodName</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> (</span><span style="color:#75715e">{{</span><span style="color:#66d9ef">range</span> <span style="color:#a6e22e">.InputParams</span><span style="color:#75715e">}}{{</span><span style="color:#66d9ef">call</span> <span style="color:#a6e22e">$i</span><span style="color:#75715e">}}{{</span><span style="color:#a6e22e">.Name</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> </span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Type</span><span style="color:#75715e">}}{{</span><span style="color:#66d9ef">end</span><span style="color:#75715e">}}</span><span style="color:#e6db74">) ( 
</span><span style="color:#e6db74">		</span><span style="color:#75715e">{{</span><span style="color:#66d9ef">range</span> <span style="color:#a6e22e">.OutputParams</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> </span><span style="color:#75715e">{{</span><span style="color:#66d9ef">call</span> <span style="color:#a6e22e">$o</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> </span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Name</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> </span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Type</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> </span><span style="color:#75715e">{{</span><span style="color:#66d9ef">end</span><span style="color:#75715e">}}</span><span style="color:#e6db74">){
</span><span style="color:#e6db74">			op := client.Operation{
</span><span style="color:#e6db74">				HTTPMethod: http.Method</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Verb</span><span style="color:#75715e">}}</span><span style="color:#e6db74">,
</span><span style="color:#e6db74">				HTTPPath:   endpoint + &#34;/</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Path</span><span style="color:#75715e">}}</span><span style="color:#e6db74">&#34;,
</span><span style="color:#e6db74">			}
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">			</span><span style="color:#75715e">{{</span><span style="color:#a6e22e">.Body</span><span style="color:#75715e">}}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">			var response </span><span style="color:#75715e">{{</span><span style="color:#f92672">(</span><span style="color:#66d9ef">index</span> <span style="color:#a6e22e">.OutputParams</span> <span style="color:#a6e22e">0</span><span style="color:#f92672">)</span><span style="color:#a6e22e">.Type</span><span style="color:#75715e">}}</span><span style="color:#e6db74">
</span><span style="color:#e6db74">			req, err := c.cl.NewRequest(op, &amp;response, nil)
</span><span style="color:#e6db74">			if err != nil {
</span><span style="color:#e6db74">				</span><span style="color:#75715e">{{</span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">eq</span> <span style="color:#a6e22e">$length</span> <span style="color:#a6e22e">1</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> return nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">else</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> return response, nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">end</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> 
</span><span style="color:#e6db74">			}
</span><span style="color:#e6db74">			if err := req.Send(); err != nil {
</span><span style="color:#e6db74">				</span><span style="color:#75715e">{{</span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">eq</span> <span style="color:#a6e22e">$length</span> <span style="color:#a6e22e">1</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> return nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">else</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> return response, nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">end</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> 
</span><span style="color:#e6db74">			}
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">			</span><span style="color:#75715e">{{</span><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">eq</span> <span style="color:#a6e22e">$length</span> <span style="color:#a6e22e">1</span><span style="color:#75715e">}}</span><span style="color:#e6db74"> return nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">else</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> return response, nil </span><span style="color:#75715e">{{</span> <span style="color:#66d9ef">end</span> <span style="color:#75715e">}}</span><span style="color:#e6db74"> 
</span><span style="color:#e6db74">		}
</span><span style="color:#e6db74">`</span>

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">separator</span>(<span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">string</span> {
	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">string</span> {
		<span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
	}
}
</code></pre></div><p>The injection looks like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">api</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">apis</span> {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">Methods</span> {
		<span style="color:#a6e22e">t</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">Must</span>(<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;func&#34;</span>).
			<span style="color:#a6e22e">Funcs</span>(<span style="color:#a6e22e">template</span>.<span style="color:#a6e22e">FuncMap</span>{<span style="color:#e6db74">&#34;separator&#34;</span>: <span style="color:#a6e22e">separator</span>}).
			<span style="color:#a6e22e">Parse</span>(<span style="color:#a6e22e">fnTmpl</span>))
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Execute</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">method</span>)
	}
}
</code></pre></div><p>And there you have it. The generation parts.
To get this to work with <code>go generate</code> all you have to do is add this to the
root file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//go:generate go run internal/cmd/genmethods/generator.go
</span></code></pre></div>
        </div>
        


<div class="post-info">
    
        <div class="post-date">2020-03-14</div>
    
    <div class="post-taxonomies">
        
            
                <ul class="post-tags">
                    
                        <li><a href="https://geekandlatin.com/tags/go">#go</a></li>
                    
                        <li><a href="https://geekandlatin.com/tags/ast">#ast</a></li>
                    
                        <li><a href="https://geekandlatin.com/tags/code-generation">#code generation</a></li>
                    
                </ul>
        
    </div>
</div>

    </article>
    
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "sudarshan-reddy-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    


        </main>
        <footer>
            
                
                

                <p>© Sudarshan Reddy, 2020<br>
Powered by <a target="_blank" href="https://gohugo.io/">Hugo</a>, theme <a target="_blank" href="https://github.com/sudarshan-reddy/hugo-theme-osiris">Osiris</a>.
</p>

            
        </footer>
    </div>
</body>
</html>
